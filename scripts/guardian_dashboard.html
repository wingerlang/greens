<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian 2.0</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-sidebar: #020617;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .brand {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
        }
        .status-dot.running { background: var(--success); }
        .status-dot.stopped { background: var(--danger); }
        .status-dot.starting { background: var(--warning); }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            background: var(--bg-card);
        }

        .view-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Grid & Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.8rem; font-weight: bold; margin-top: 5px; }
        .stat-sub { font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px; }

        /* Terminal */
        .terminal-container {
            flex: 1;
            background: #000;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 400px;
        }

        .terminal-header {
            background: #111;
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            font-size: 0.8rem;
            color: #888;
            display: flex;
            justify-content: space-between;
        }

        .terminal-body {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry { margin-bottom: 2px; white-space: pre-wrap; word-break: break-all; }
        .log-stdout { color: #d1d5db; }
        .log-stderr { color: #fca5a5; }
        .log-info { color: #7dd3fc; }
        .log-ts { color: #4b5563; margin-right: 8px; user-select: none; font-size: 0.8em; }

        /* Controls */
        .controls { display: flex; gap: 10px; }
        button {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        button:hover { background: #334155; }
        button.primary { background: var(--accent); border-color: var(--accent); color: white; }
        button.primary:hover { background: #2563eb; }
        button.danger { border-color: var(--danger); color: var(--danger); }
        button.danger:hover { background: var(--danger); color: white; }

        /* Split View */
        .split-view {
            display: flex;
            gap: 20px;
            height: 100%;
        }
        .split-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand">üõ°Ô∏è Guardian</div>
    <div id="nav-list">
        <!-- Generated via JS -->
    </div>

    <div style="margin-top: auto;">
        <div class="nav-item" onclick="toggleDualView()" id="dual-view-btn">
            <span>ü™ü Dual View</span>
        </div>
    </div>
</div>

<div class="main">
    <div class="top-bar">
        <h2 id="page-title" style="margin:0; font-size: 1.2rem;">Overview</h2>
        <div class="controls" id="global-controls">
            <!-- Dynamic Controls -->
        </div>
    </div>

    <div class="view-content" id="content-area">
        <!-- Dynamic Content -->
    </div>
</div>

<script>
    // State
    let services = [];
    let systemStats = {};
    let activeTab = 'overview'; // 'overview' | serviceName
    let dualView = false;
    let secondaryTab = null; // for dual view
    let logBuffers = {}; // serviceName -> logs[]

    // --- API ---

    async function fetchStatus() {
        try {
            const res = await fetch('/api/status');
            const data = await res.json();
            services = data.services;
            systemStats = data;
            renderNav();
            renderContent();
        } catch (e) {
            console.error("Connection lost", e);
        }
    }

    async function fetchLogs(serviceName) {
        if (!serviceName) return;
        try {
            const res = await fetch(`/api/logs?service=${serviceName}`);
            const logs = await res.json();

            // Simple check to see if we need to update DOM
            // In a real app we'd use a smarter diff or append
            const currentLen = (logBuffers[serviceName] || []).length;
            if (logs.length > currentLen) {
                logBuffers[serviceName] = logs;
                updateTerminal(serviceName);
            }
        } catch (e) { console.error(e); }
    }

    async function controlService(name, action) {
        if (!confirm(`${action.toUpperCase()} ${name}?`)) return;
        await fetch(`/api/control?service=${name}&action=${action}`, { method: 'POST' });
        fetchStatus();
    }

    async function globalAction(action) {
        if (!confirm(`Run ${action}?`)) return;
        await fetch(`/api/global?action=${action}`, { method: 'POST' });
    }

    // --- Rendering ---

    function renderNav() {
        const list = document.getElementById('nav-list');
        let html = `
            <div class="nav-item ${activeTab === 'overview' ? 'active' : ''}" onclick="setTab('overview')">
                <span>Overview</span>
            </div>
            <div style="height: 1px; background: var(--border); margin: 10px 0;"></div>
        `;

        services.forEach(s => {
            html += `
                <div class="nav-item ${activeTab === s.name ? 'active' : ''}" onclick="setTab('${s.name}')">
                    <span>${capitalize(s.name)}</span>
                    <div class="status-dot ${s.status}"></div>
                </div>
            `;
        });

        if (list.innerHTML !== html) list.innerHTML = html;
    }

    function renderContent() {
        const container = document.getElementById('content-area');
        const title = document.getElementById('page-title');
        const globalControls = document.getElementById('global-controls');

        if (activeTab === 'overview') {
            title.textContent = "System Overview";
            globalControls.innerHTML = `
                <button onclick="globalAction('git-pull')">‚¨áÔ∏è Git Pull</button>
                <button onclick="globalAction('build')">üèóÔ∏è Build</button>
                <button class="danger" onclick="globalAction('restart-all')">üîÑ Restart All</button>
            `;
            container.innerHTML = renderOverview();
        } else if (dualView) {
            title.textContent = "Dual View";
            globalControls.innerHTML = `
                <select id="secondary-select" onchange="setSecondary(this.value)" style="background:var(--bg-card); color:white; border:1px solid var(--border); padding:5px; border-radius:4px;">
                    <option value="">Select Service...</option>
                    ${services.map(s => `<option value="${s.name}" ${secondaryTab === s.name ? 'selected' : ''}>${s.name}</option>`).join('')}
                </select>
                <button onclick="toggleDualView()">Close Dual</button>
            `;

            // Only re-render structure if needed, update contents dynamically
            if (!document.getElementById('dual-split')) {
                container.innerHTML = `
                    <div id="dual-split" class="split-view">
                        <div class="split-pane" id="pane-primary"></div>
                        <div class="split-pane" id="pane-secondary" style="border-left: 1px solid var(--border); padding-left: 20px;"></div>
                    </div>
                `;
            }

            renderServicePane(activeTab, document.getElementById('pane-primary'));
            if (secondaryTab) {
                renderServicePane(secondaryTab, document.getElementById('pane-secondary'));
            } else {
                document.getElementById('pane-secondary').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#666;">Select a second service</div>';
            }

        } else {
            const service = services.find(s => s.name === activeTab);
            if (!service) return;

            title.textContent = capitalize(service.name);
            globalControls.innerHTML = getServiceControls(service);

            // Check if we already have the structure to avoid clearing terminal
            if (!document.getElementById(`service-view-${service.name}`)) {
                container.innerHTML = `<div id="service-view-${service.name}" style="display:flex; flex-direction:column; height:100%; gap:20px;"></div>`;
            }

            const view = document.getElementById(`service-view-${service.name}`);
            renderServicePane(service.name, view);
        }
    }

    function renderOverview() {
        if (!systemStats.services) return 'Loading...';

        const totalCpu = services.reduce((acc, s) => acc + (s.cpu || 0), 0).toFixed(1);
        const totalMem = formatBytes(services.reduce((acc, s) => acc + (s.memory || 0), 0));

        // System info
        const sysMem = systemStats.system ?
            `${Math.round((systemStats.system.total - systemStats.system.free) / systemStats.system.total * 100)}%` : 'N/A';

        return `
            <div class="grid">
                <div class="card">
                    <div class="stat-label">Total App CPU</div>
                    <div class="stat-value">${totalCpu}%</div>
                </div>
                <div class="card">
                    <div class="stat-label">Total App Memory</div>
                    <div class="stat-value">${totalMem}</div>
                </div>
                <div class="card">
                    <div class="stat-label">System Memory</div>
                    <div class="stat-value">${sysMem}</div>
                </div>
                 <div class="card">
                    <div class="stat-label">Active Services</div>
                    <div class="stat-value">${services.filter(s => s.status === 'running').length}/${services.length}</div>
                </div>
            </div>

            <h3>Services</h3>
            <div class="grid">
                ${services.map(s => `
                    <div class="card" onclick="setTab('${s.name}')" style="cursor:pointer; border-left: 4px solid ${getStatusColor(s.status)}">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${capitalize(s.name)}</strong>
                            <span style="color:${getStatusColor(s.status)}">${s.status.toUpperCase()}</span>
                        </div>
                        <div class="stat-sub">CPU: ${s.cpu?.toFixed(1)}% | Mem: ${formatBytes(s.memory)}</div>
                        <div class="stat-sub">Restarts: ${s.restarts}</div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderServicePane(serviceName, container) {
        const s = services.find(x => x.name === serviceName);
        if (!s) return;

        // Create structure if missing
        if (!container.querySelector('.service-stats')) {
            container.innerHTML = `
                <div class="grid service-stats" style="grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                    <!-- Stats injected here -->
                </div>
                <div class="terminal-container">
                    <div class="terminal-header">
                        <span>Terminal (${s.name})</span>
                        <span class="log-count">0 lines</span>
                    </div>
                    <div class="terminal-body" id="term-${s.name}"></div>
                </div>
            `;
        }

        // Update Stats
        const statsEl = container.querySelector('.service-stats');
        statsEl.innerHTML = `
            <div class="card" style="padding:15px">
                <div class="stat-label">Status</div>
                <div style="color:${getStatusColor(s.status)}; font-weight:bold">${s.status.toUpperCase()}</div>
            </div>
             <div class="card" style="padding:15px">
                <div class="stat-label">CPU</div>
                <div>${s.cpu?.toFixed(1)}%</div>
            </div>
             <div class="card" style="padding:15px">
                <div class="stat-label">Memory</div>
                <div>${formatBytes(s.memory)}</div>
            </div>
             <div class="card" style="padding:15px">
                <div class="stat-label">Uptime</div>
                <div>${formatTime(s.uptime)}</div>
            </div>
        `;

        // We trigger log update check separately to not spam DOM
        // The fetchLogs loop handles the data, updateTerminal handles the DOM
    }

    function updateTerminal(serviceName) {
        const termId = `term-${serviceName}`;
        const termBody = document.getElementById(termId);
        if (!termBody) return;

        const logs = logBuffers[serviceName] || [];
        const wasAtBottom = termBody.scrollHeight - termBody.scrollTop <= termBody.clientHeight + 50;

        // Optimization: Only append new logs if possible, but simplest is full rebuild for now
        // To avoid flicker and performance issues with massive DOM, we'll just take last 1000

        termBody.innerHTML = logs.map(l => `
            <div class="log-entry log-${l.source}">
                <span class="log-ts">[${formatDate(l.timestamp)}]</span>${escapeHtml(l.message)}
            </div>
        `).join('');

        if (wasAtBottom) termBody.scrollTop = termBody.scrollHeight;

        // Update count
        const header = termBody.parentElement.querySelector('.log-count');
        if (header) header.textContent = `${logs.length} lines`;
    }

    function getServiceControls(s) {
        if (s.name === 'guardian') return '<span style="color:#666">Self-managed</span>';

        const isRunning = s.status === 'running';
        return `
            ${!isRunning ? `<button class="primary" onclick="controlService('${s.name}', 'start')">‚ñ∂ Start</button>` : ''}
            ${isRunning ? `<button class="danger" onclick="controlService('${s.name}', 'stop')">‚èπ Stop</button>` : ''}
            <button onclick="controlService('${s.name}', 'restart')">üîÑ Restart</button>
            <a href="${s.name === 'frontend' ? 'http://localhost:3000' : 'http://localhost:8000'}" target="_blank" class="button">üîó Open</a>
        `;
    }

    // --- Helpers ---

    function setTab(tab) {
        activeTab = tab;
        renderNav();
        renderContent();
    }

    function toggleDualView() {
        dualView = !dualView;
        if (dualView) {
            if (activeTab === 'overview') {
                const first = services.find(s => s.name !== 'guardian');
                if (first) {
                    activeTab = first.name;
                    renderNav();
                }
            }
            if (!secondaryTab) {
                const other = services.find(s => s.name !== activeTab && s.name !== 'guardian');
                if (other) secondaryTab = other.name;
            }
        }
        renderContent();
    }

    function setSecondary(val) {
        secondaryTab = val;
        renderContent();
    }

    function capitalize(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function formatBytes(bytes) {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function formatTime(sec) {
        if (!sec) return '0s';
        if (sec < 60) return sec + 's';
        const m = Math.floor(sec / 60);
        if (m < 60) return m + 'm ' + (sec % 60) + 's';
        return Math.floor(m / 60) + 'h ' + (m % 60) + 'm';
    }

    function formatDate(iso) {
        const d = new Date(iso);
        return d.toLocaleTimeString('en-US', { hour12: false });
    }

    function getStatusColor(status) {
        const map = { running: 'var(--success)', stopped: 'var(--text-secondary)', crashed: 'var(--danger)', starting: 'var(--warning)' };
        return map[status] || 'gray';
    }

    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // --- Loop ---

    setInterval(fetchStatus, 1000);
    setInterval(() => {
        // Fetch logs for active views
        if (activeTab !== 'overview') fetchLogs(activeTab);
        if (dualView && secondaryTab) fetchLogs(secondaryTab);
    }, 2000);

    // Init
    fetchStatus();

</script>
</body>
</html>