<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Dashboard</title>
    <style>
        :root {
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --accent: #3b82f6;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .badge { padding: 4px 12px; border-radius: 99px; font-weight: bold; font-size: 0.9em; }
        .badge.running { background: var(--success); color: #000; }
        .badge.stopped { background: var(--danger); color: #fff; }
        .badge.crashed { background: var(--danger); color: #fff; }
        .badge.starting { background: var(--warning); color: #000; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .card h3 { margin: 0 0 10px 0; color: var(--text-dim); font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.05em; }
        .card .value { font-size: 1.8em; font-weight: bold; }
        .card .sub { font-size: 0.8em; color: var(--text-dim); margin-top: 5px; }

        .actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { background: var(--card-bg); color: var(--text); border: 1px solid #334155; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        button:hover { background: #334155; }
        button.primary { background: var(--accent); color: white; border: none; }
        button.primary:hover { background: #2563eb; }
        button.danger { border-color: var(--danger); color: var(--danger); }
        button.danger:hover { background: var(--danger); color: white; }

        .terminal { background: #000; border-radius: 12px; padding: 20px; height: 500px; overflow-y: auto; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 0.9em; border: 1px solid #334155; }
        .log-entry { margin-bottom: 4px; line-height: 1.4; white-space: pre-wrap; word-break: break-all; }
        .log-entry.stderr { color: #fca5a5; }
        .log-entry.guardian { color: #7dd3fc; font-style: italic; }
        .log-entry.stdout { color: #d1d5db; }
        .timestamp { color: #4b5563; margin-right: 10px; user-select: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Guardian Dashboard</h1>
            <div id="status-badge" class="badge stopped">OFFLINE</div>
        </div>

        <div class="grid">
            <div class="card">
                <h3>Uptime</h3>
                <div class="value" id="uptime">0s</div>
                <div class="sub">Since last start</div>
            </div>
            <div class="card">
                <h3>Restarts</h3>
                <div class="value" id="restarts">0</div>
                <div class="sub" id="last-exit">No exits yet</div>
            </div>
            <div class="card">
                <h3>Memory (RSS)</h3>
                <div class="value" id="memory">0 MB</div>
                <div class="sub">Guardian Process</div>
            </div>
            <div class="card">
                <h3>System Memory</h3>
                <div class="value" id="sys-memory">0%</div>
                <div class="sub" id="sys-memory-sub">0/0 GB</div>
            </div>
        </div>

        <div class="actions">
            <button class="primary" onclick="doAction('restart')">üîÑ Restart Server</button>
            <button onclick="doAction('git-pull')">‚¨áÔ∏è Git Pull</button>
            <button onclick="doAction('build')">üèóÔ∏è Build</button>
            <button class="danger" onclick="doAction('deploy')">üöÄ Full Deploy</button>
        </div>

        <div class="terminal" id="terminal">
            <div class="log-entry guardian">Connecting to Guardian...</div>
        </div>
    </div>

    <script>
        const terminal = document.getElementById('terminal');
        let lastLogCount = 0;

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            if (seconds < 60) return seconds + 's';
            const m = Math.floor(seconds / 60);
            if (m < 60) return m + 'm ' + (seconds % 60) + 's';
            const h = Math.floor(m / 60);
            return h + 'h ' + (m % 60) + 'm';
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                // Update badge
                const badge = document.getElementById('status-badge');
                badge.className = 'badge ' + data.status;
                badge.textContent = data.status.toUpperCase();

                // Update cards
                document.getElementById('uptime').textContent = formatTime(data.uptimeSeconds);
                document.getElementById('restarts').textContent = data.restartCount;
                document.getElementById('last-exit').textContent = data.lastExitCode !== null ? `Last Code: ${data.lastExitCode}` : 'Clean run';

                // Memory
                document.getElementById('memory').textContent = formatBytes(data.memory.rss);

                // System Memory
                if (data.systemMemory) {
                    const free = data.systemMemory.free;
                    const total = data.systemMemory.total;
                    const used = total - free;
                    const pct = Math.round((used / total) * 100);
                    document.getElementById('sys-memory').textContent = pct + '%';
                    document.getElementById('sys-memory-sub').textContent = formatBytes(used) + ' / ' + formatBytes(total);
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function updateLogs() {
            try {
                const res = await fetch('/api/logs');
                const logs = await res.json();

                if (logs.length > lastLogCount) {
                    const newLogs = logs.slice(lastLogCount);
                    const wasAtBottom = terminal.scrollHeight - terminal.scrollTop === terminal.clientHeight;

                    newLogs.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'log-entry ' + log.source;
                        // Escape HTML to prevent injection
                        const text = document.createTextNode(log.message);
                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'timestamp';
                        timeSpan.textContent = `[${new Date(log.timestamp).toLocaleTimeString()}] `;

                        div.appendChild(timeSpan);
                        div.appendChild(text);
                        terminal.appendChild(div);
                    });

                    lastLogCount = logs.length;

                    if (wasAtBottom) {
                        terminal.scrollTop = terminal.scrollHeight;
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function doAction(action) {
            if(confirm(`Execute ${action}?`)) {
                 await fetch(`/api/${action}`, { method: 'POST' });
            }
        }

        // Init
        setInterval(updateStatus, 1000);
        setInterval(updateLogs, 2000);
        updateStatus();
        updateLogs();
    </script>
</body>
</html>
